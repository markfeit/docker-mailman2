#!/bin/sh -e
#
# Run Mailman
#

export PATH="/usr/lib/mailman/bin:${PATH}"

install -m644 -o root -g root /usr/lib/mailman/cron/crontab.in /etc/cron.d/mailman
touch /var/log/mailman/error
chown mailman:mailman /var/log/mailman/error
chmod 660 /var/log/mailman/error

echo "Starting Mailman"
mailman-update-cfg
mailmanctl -s start

# TODO: Check if this gets run when the container is stopped.

stop_mailman()
{
    echo "Stopping Mailman"
    /usr/lib/mailman/bin/mailman-update-cfg
    /usr/lib/mailman/bin/mailmanctl stop
    cat > /etc/cron.d/mailman <<EOF
# DO NOT EDIT THIS FILE!
#
# Contents of this file managed by mailman
# Master copy is /usr/lib/mailman/cron/crontab.in
EOF
}
trap stop_mailman EXIT

# Do nothing useful until we get stopped
while true
do
    sleep 3600
done
